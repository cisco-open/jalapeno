# Centos VM packaging
As of January 2020 Jalapeno's Openshift cluster is packaged on a Centos VM.  The VM may be launched via standard virsh (see os_base1.xml).  The Centos VM is built with two vNICs, one for server/host management reachability, and one attached to the Jalapeno virtual network (see https://wwwin-github.cisco.com/spa-ie/jalapeno-testbed)
Once launched, the user will need to modify a few openshift config files on the VM, and add iptables rules on the server host to enable port forwarding to Openshift and Jalapeno's services that come with UI's.

## Procedure:
1. copy the centos VM and supplemental storage qcow2's to the VM image repository on your server host. The following files are located in `/opt/images/jalapeno/` on the server (Bruce-Dev or Naja).
```
openshift1.qcow2
openshift1-vdb.qcow2
```

2. copy os_base1.xml to your server host, make edits to the xml as needed, define the VM, and launch it:
```
virsh define os_base1.xml
virsh start os_base1
```
3. connect to the centos VM and perform the following steps to modify Openshift's IP info to work in your environment:
```
virsh console os_base1
user = centos
password = cisco

# Once connected:

1. shutdown openshift
sudo systemctl stop origin-node
sudo systemctl stop origin-node-dep
sudo systemctl stop origin-master

2. edit the following files in /etc/origin, find all lines with the previous server host IP address and replace them with the IP address of your server host:
./master/openshift-master.kubeconfig
./master/admin.kubeconfig
./master/master-config.yaml

example: in master-config.yaml

  masterPublicURL: https://10.200.99.3:8443
  publicURL: https://10.200.99.3:8443/console/

change 10.200.99.3 to be the IP of your server

3. restart openshift
sudo systemctl start origin-master
sudo systemctl start origin-node
sudo systemctl start origin-node-dep
```

4. change the Centos VM's management IP address to fit your environment
```
[root@os_base master]# cat /etc/sysconfig/network-scripts/ifcfg-ens3
# Generated by parse-kickstart
UUID=b7eb00d1-60b9-4b57-8848-fc34912ca2f1
IPV6_AUTOCONF=yes
BOOTPROTO=static
DEVICE=ens3
ONBOOT=yes
IPV6INIT=yes
TYPE=Ethernet
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
NAME="System ens3"
IPADDR=10.251.251.250
PREFIX=24
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes

```

5. update relevant proxy settings on the centos VM
6. Create the following iptables port forwarding entries on your server host

```
openshift
sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 8443 -j DNAT --to-destination <centos_vm_mgt_ip>:8443

Arango
sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 30852 -j DNAT --to-destination <centos_vm_mgt_ip>:30852

Kafka
sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 30308 -j DNAT --to-destination <centos_vm_mgt_ip>:30308

Grafana
sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 30300 -j DNAT --to-destination <centos_vm_mgt_ip>:30300

NAT source address of inbound traffic to Openshift, Arango, etc.
sudo iptables -t nat -A POSTROUTING -o <name_of_mgt_br> -j MASQUERADE


```
